---
alwaysApply: true
---
## ğŸ—ï¸ **KIáº¾N TRÃšC STARTKIT**

### **Cáº¥u TrÃºc ThÆ° Má»¥c Backend**
```
backend/src/modules/
â”œâ”€â”€ api/                    # API Controllers & Swagger
â”‚   â”œâ”€â”€ controllers/        # REST API endpoints
â”‚   â”œâ”€â”€ guards/            # Authentication guards
â”‚   â”œâ”€â”€ interceptors/      # Response formatting
â”‚   â””â”€â”€ dto/              # Data Transfer Objects
â”œâ”€â”€ business/              # Business Logic Services
â”‚   â”œâ”€â”€ services/          # Core business services
â”‚   â”œâ”€â”€ validators/        # Business validation
â”‚   â””â”€â”€ factories/         # Service factories
â”œâ”€â”€ database/              # Database Layer
â”‚   â”œâ”€â”€ entities/          # TypeORM entities
â”‚   â”œâ”€â”€ repositories/      # Custom repositories
â”‚   â”œâ”€â”€ migrations/        # Database migrations
â”‚   â””â”€â”€ seeders/           # Data seeding
â”œâ”€â”€ worker/                # Background Workers
â”‚   â”œâ”€â”€ consumers/         # Queue consumers
â”‚   â”œâ”€â”€ schedulers/        # Cron jobs
â”‚   â””â”€â”€ processors/        # Job processors
â”œâ”€â”€ queue/                 # Queue Management
â”‚   â”œâ”€â”€ queues/            # Queue definitions
â”‚   â””â”€â”€ processors/        # Queue processors
â”œâ”€â”€ websocket/             # Real-time Communication
â”‚   â”œâ”€â”€ gateways/          # Socket.io gateways
â”‚   â””â”€â”€ events/            # WebSocket events
â””â”€â”€ shared/                # Shared Utilities
    â”œâ”€â”€ constants/         # App constants
    â”œâ”€â”€ decorators/        # Custom decorators
    â””â”€â”€ utils/             # Utility functions
```

### **Quy Táº¯c PhÃ¢n Chia Module**

#### **1. API Layer (`modules/api/`)**
```typescript
// âœ… ÄÃšNG - Controller trong api/controllers
@Controller('shops')
@ApiTags('Shop Management')
export class ShopController {
  constructor(private readonly shopService: ShopService) {}
  
  @Get()
  @ApiOperation({ summary: 'Láº¥y danh sÃ¡ch cá»­a hÃ ng' })
  async getShops() {
    return this.shopService.findAll();
  }
}

// âŒ SAI - Controller trong business/
export class ShopController { }
```

#### **2. Business Layer (`modules/business/services/`)**
```typescript
// âœ… ÄÃšNG - Service trong business/services
@Injectable()
export class ShopService {
  constructor(
    private readonly shopRepository: ShopRepository,
    private readonly openAIService: OpenAIService
  ) {}
  
  async findAll(): Promise<Shop[]> {
    return this.shopRepository.find();
  }
}

// âŒ SAI - Service trong api/
export class ShopService { }
```

#### **3. Database Layer (`modules/database/`)**
```typescript
// âœ… ÄÃšNG - Repository trong database/repositories
@Injectable()
export class ShopRepository extends Repository<ShopEntity> {
  async findByLocation(lat: number, lng: number, radius: number = 10) {
    return this.createQueryBuilder('shop')
      .where('ST_DWithin(shop.location, ST_Point(:lng, :lat), :radius)',
        { lng, lat, radius })
      .getMany();
  }
}

// âŒ SAI - Repository trong business/
export class ShopRepository { }
```

#### **4. Worker Layer (`modules/worker/`)**
```typescript
// âœ… ÄÃšNG - Consumer trong worker/consumers
@Processor('chatbot')
export class ChatbotConsumer {
  @Process('process-message')
  async processMessage(job: Job<ProcessMessageDto>) {
    // Background job processing
  }
}

// âŒ SAI - Consumer trong business/
export class ChatbotConsumer { }
```

---

## ğŸ” **Há»† THá»NG PHÃ‚N QUYá»€N (RBAC)**

### **Role Hierarchy**
```typescript
// âœ… ÄÃšNG - Sá»­ dá»¥ng RBAC system
export enum UserRole {
  SYSTEM_ADMIN = 'system_admin',
  SHOP_OWNER = 'shop_owner', 
  SHOP_MANAGER = 'shop_manager',
  SHOP_STAFF = 'shop_staff',
  CUSTOMER_SERVICE = 'customer_service',
  CUSTOMER = 'customer'
}

// âŒ SAI - Simple role string
const role = 'admin';
```

### **Permission Checking**
```typescript
// âœ… ÄÃšNG - Sá»­ dá»¥ng permission decorator
@UseGuards(JwtAuthGuard, PermissionGuard)
@RequirePermissions('shop:read', 'own_shops')
@Get('my-shops')
async getMyShops(@CurrentUser() user: User) {
  return this.shopService.findByOwner(user.id);
}

// âŒ SAI - Manual permission check
@Get('my-shops')
async getMyShops(@CurrentUser() user: User) {
  if (user.role !== 'shop_owner') {
    throw new ForbiddenException();
  }
}
```

---

## ğŸ“ **API DOCUMENTATION**

### **Swagger Documentation**
```typescript
// âœ… ÄÃšNG - Complete Swagger documentation
@Controller('shops')
@ApiTags('Shop Management')
export class ShopController {
  
  @Post()
  @ApiOperation({
    summary: 'Táº¡o cá»­a hÃ ng má»›i',
    description: 'Táº¡o má»™t cá»­a hÃ ng má»›i vá»›i thÃ´ng tin cÆ¡ báº£n'
  })
  @ApiBody({ type: CreateShopDto })
  @ApiResponse({
    status: HttpStatus.CREATED,
    description: 'Cá»­a hÃ ng Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng',
    type: StandardResponseDto<ShopResponseDto>
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: 'Dá»¯ liá»‡u Ä‘áº§u vÃ o khÃ´ng há»£p lá»‡'
  })
  async createShop(@Body() createShopDto: CreateShopDto) {
    return this.shopService.create(createShopDto);
  }
}

// âŒ SAI - Missing Swagger documentation
@Post()
async createShop(@Body() dto: any) {
  return this.shopService.create(dto);
}
```

### **DTO Validation**
```typescript
// âœ… ÄÃšNG - Complete DTO vá»›i validation
export class CreateShopDto {
  @ApiProperty({
    description: 'TÃªn cá»­a hÃ ng',
    example: 'Cá»­a hÃ ng ABC',
    minLength: 3,
    maxLength: 100
  })
  @IsString()
  @IsNotEmpty()
  @MinLength(3)
  @MaxLength(100)
  name: string;

  @ApiPropertyOptional({
    description: 'MÃ´ táº£ cá»­a hÃ ng',
    example: 'Cá»­a hÃ ng chuyÃªn bÃ¡n Ä‘á»“ Ä‘iá»‡n tá»­'
  })
  @IsString()
  @IsOptional()
  description?: string;
}

// âŒ SAI - Missing validation
export class CreateShopDto {
  name: string;
  description?: string;
}
```

---

## ğŸ”„ **RESPONSE FORMAT**

### **Standard Response Format**
```typescript
// âœ… ÄÃšNG - Sá»­ dá»¥ng standard response format
@Get()
async getShops(): Promise<StandardResponseDto<ShopResponseDto[]>> {
  const shops = await this.shopService.findAll();
  
  return {
    statusCode: HttpStatus.OK,
    message: 'Láº¥y danh sÃ¡ch cá»­a hÃ ng thÃ nh cÃ´ng',
    data: shops,
    timestamp: new Date().toISOString()
  };
}

// âŒ SAI - Return raw data
@Get()
async getShops(): Promise<Shop[]> {
  return this.shopService.findAll();
}
```

---

## ğŸš€ **CONDITIONAL MODULE LOADING**

### **Environment Variables**
```typescript
// âœ… ÄÃšNG - Conditional module loading
const isApi = Boolean(Number(process.env.IS_API || 0));
const isWorker = Boolean(Number(process.env.IS_WORKER || 0));

@Module({
  imports: [
    // Conditional modules
    ...(isApi ? [ApiModule] : []),
    ...(isWorker ? [WorkerModule] : []),
    // Shared modules
    BusinessModule,
    DatabaseModule,
    QueueModule,
  ]
})
export class AppModule {}

// âŒ SAI - Load all modules
@Module({
  imports: [ApiModule, WorkerModule, BusinessModule]
})
export class AppModule {}
```

---

## ğŸ§ª **TESTING PATTERNS**

### **Unit Testing**
```typescript
// âœ… ÄÃšNG - Test theo startkit patterns
describe('ShopService', () => {
  let service: ShopService;
  let repository: ShopRepository;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        ShopService,
        {
          provide: ShopRepository,
          useValue: {
            find: jest.fn(),
            save: jest.fn(),
          },
        },
      ],
    }).compile();

    service = module.get<ShopService>(ShopService);
    repository = module.get<ShopRepository>(ShopRepository);
  });

  it('should return shops list', async () => {
    const mockShops = [/* mock data */];
    jest.spyOn(repository, 'find').mockResolvedValue(mockShops);

    const result = await service.findAll();
    expect(result).toEqual(mockShops);
  });
});
```

---

## ğŸ”§ **ERROR HANDLING**

### **Exception Handling**
```typescript
// âœ… ÄÃšNG - Proper error handling
@Injectable()
export class ShopService {
  async findById(id: string): Promise<Shop> {
    try {
      const shop = await this.shopRepository.findOne({ where: { id } });
      
      if (!shop) {
        throw new NotFoundException(`KhÃ´ng tÃ¬m tháº¥y cá»­a hÃ ng vá»›i ID: ${id}`);
      }
      
      return shop;
    } catch (error) {
      console.error(`[ğŸ”´] [ShopService] [findById] [error]:`, error);
      throw error;
    }
  }
}

// âŒ SAI - No error handling
async findById(id: string): Promise<Shop> {
  return this.shopRepository.findOne({ where: { id } });
}
```

---

## ğŸ“Š **LOGGING PATTERNS**

### **Structured Logging**
```typescript
// âœ… ÄÃšNG - Structured logging vá»›i Pino
@Injectable()
export class ShopService {
  private readonly logger = new Logger(ShopService.name);

  async createShop(createShopDto: CreateShopDto): Promise<Shop> {
    this.logger.log(`[âœ…] [ShopService] [createShop] [dto]:`, createShopDto);
    
    try {
      const shop = await this.shopRepository.save(createShopDto);
      this.logger.log(`[âœ…] [ShopService] [createShop] [result]:`, shop);
      return shop;
    } catch (error) {
      this.logger.error(`[ğŸ”´] [ShopService] [createShop] [error]:`, error);
      throw error;
    }
  }
}

// âŒ SAI - Console.log
async createShop(dto: any) {
  console.log('Creating shop:', dto);
  return this.repository.save(dto);
}
```

---

## ğŸ¯ **BEST PRACTICES**

### **1. Dependency Injection**
- LuÃ´n sá»­ dá»¥ng constructor injection
- KhÃ´ng sá»­ dá»¥ng `new` keyword trong services
- Sá»­ dá»¥ng interfaces cho loose coupling

### **2. Type Safety**
- LuÃ´n Ä‘á»‹nh nghÄ©a types/interfaces
- Sá»­ dá»¥ng strict TypeScript config
- TrÃ¡nh sá»­ dá»¥ng `any` type

### **3. Performance**
- Sá»­ dá»¥ng caching cho expensive operations
- Implement pagination cho large datasets
- Optimize database queries vá»›i indexes

### **4. Security**
- Validate táº¥t cáº£ input data
- Sá»­ dá»¥ng RBAC cho authorization
- Sanitize user inputs
- Implement rate limiting

---

## ğŸ“š **REFERENCES**

- [NestJS Documentation](https://docs.nestjs.com/)
- [TypeORM Documentation](https://typeorm.io/)
- [Swagger Documentation](https://swagger.io/docs/)
- [Bull Queue Documentation](https://docs.bullmq.io/)
- [Socket.io Documentation](https://socket.io/docs/)

---

**ğŸ¯ Má»¥c tiÃªu: Táº¥t cáº£ code pháº£i tuÃ¢n theo startkit patterns vÃ  best practices!**

---
description: Cursor Rules cho dá»± Ã¡n ShopChat.vn - AI Chatbot bÃ¡n hÃ ng
globs: 
  - "**/*.ts"
  - "**/*.js"
  - "**/*.tsx"
  - "**/*.jsx"
  - "**/*.md"
  - "**/*.json"
alwaysApply: true
---

